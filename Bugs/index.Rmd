---
title: "2017-18 Benthic Community Analysis"
author: "Cedar Mackaness"
date: "12/01/2018"
output: 
  html_document:
    theme: sandstone
    highlight: tango
    keep_md: true
    includes:
      before_body: header.html
      after_body: footer.html
    css: styles.css
    code_folding: "hide"
---
## Purpose of This Document 
***
Working with 2017-18 benthic invertebrate data to calculate and plot:

- Ratio's and Differences of density by family

- Ratio's and Differences of density by FFG

- Changes in scaper taxa community

- NMDS analysis

## Sections {.tabset .tabset-fade .tabset-pills}
***
<br>

```{r Load packages, include = FALSE}
# load required packages
x <- c("tidyverse", "vegan", "lubridate", "readxl", "ggthemes", "vegan", "viridis", "DT")
lapply(x, library, character.only = TRUE)
```


```{r Import data, include = FALSE}
# import data
bugs <- readxl::read_xlsx("./Data/2017-18 bugs.xlsx", sheet = "Cleaned")
ffg <- readxl::read_xlsx("./Data/2017-18 bugs.xlsx", sheet = "FFG")
sizes <- readxl::read_xlsx("./Data/2017-18 bugs.xlsx", sheet = "Size")

#Replace Ssp. in Taxon with Family
bugs$Taxon[bugs$Taxon == "Ssp."] <- bugs$Family[bugs$Taxon == "Ssp."]
```

### Setup
***

Do some basic math to calculate density of each taxon...

```{r Calculate Densities, echo = TRUE}
#Calculations...
bugs$Density <- bugs$Count / bugs$PercentSub / .09

bugs$CollDate <- as.Date(bugs$CollDate, format = "%m/%d/%y") %>% year() %>% as.factor()

bugs.agg <- bugs %>%
  group_by(CollDate, Stream, Treatment, Taxon) %>%
  summarise_at(vars(Density), funs(sum)) %>% ungroup

bugs.agg$Density <- bugs.agg$Density / 3
```

***

Here we divide Count by percent subsampled (actually a fraction) to get a count for the total sample taken.  We then divide by .09 which is the area of the surber sampler (in m$^2$). We then aggregate and divide by three (There were three samples taken per reach).


```{r Fill Missing Taxa, echo = FALSE}
# Spread and then gather to fill missing Taxons with 0's
bugs.agg <- spread(bugs.agg, key = "Taxon", value = "Density") %>% 
  mutate_if(is.numeric , replace_na, replace = 0) %>% 
  gather(key = "Taxon", value = "Density", 4:ncol(.))
```


```{r Calculate Reach Differences, echo = FALSE}
# Create list of CollDate, Stream and Taxon
bugs.by.year <- bugs.agg %>% select(-c("Density", "Treatment")) %>% unique()

# Calculate Differences
bugs.by.year$Diff <- bugs.agg$Density[bugs.agg$Treatment == "Y"] -     
  bugs.agg$Density[bugs.agg$Treatment == "N"]


bugs.by.year <- merge(bugs.by.year, sizes) %>% merge(., ffg)
bugs.agg <- merge(bugs.agg, sizes) %>% merge(., ffg)
bugs18 <- filter(bugs.agg, CollDate == "2018")

```

A quick taste of the finished data table product:

```{r, echo = FALSE}
datatable(bugs.agg, rownames = FALSE, class = "hover", filter = "top", options = list(pageLength = 10, scrollX=T), ) %>% formatRound("Density", digits = 2, interval = 3, 
                                          mark = ",", dec.mark = getOption("OutDec"))
```


### Taxa
***
```{r Plot Taxon Density Diffs, echo = FALSE, fig.height = 25, fig.width = 25}
# Plot density differences
ggplot(data = bugs.by.year, aes(x = Taxon, y = Diff, fill = CollDate)) + 
  geom_col(position = "dodge") +
  facet_wrap(c("Stream")) +
  ggtitle("Differences in Taxa Abundances Between Reaches Pre and Post Gap Years") +
  theme_bw() +
     theme(plot.title = element_text(size = 40, face = "bold")) +
  scale_fill_viridis_d(option = "E") +
  coord_flip()
```

Plot of density differences between reaches for both 2017 and 2018. As seen, there are no ubiquitous taxa that consistently increase or decrease across streams. Can also see how shitty the plot is, too many taxa...


### FFG's
***
```{r Get FFGs, echo = FALSE}
#Aggregate to get density differences of FFG's
bugs.ffg <- bugs.by.year %>% 
  group_by(FFG, Stream, CollDate) %>%
  summarise_at("Diff", funs(sum)) %>% ungroup
```


```{r Composite SC, echo = FALSE}
#Add total SC, this throws off counts (scrapers doubly reprented)
ffg.SC <- filter(bugs.ffg, FFG %in% c("SCi", "SCe"))
ffg.SC$FFG <- "SC"
ffg.SC <- ffg.SC %>% group_by(FFG, Stream, CollDate) %>%
  summarise_at(vars(Diff), funs(sum)) %>% ungroup
ffg.SC <- rbind(bugs.ffg, ffg.SC) 
```


```{r Plot FFG Density Differences, fig.height = 10, fig.width = 12, echo = FALSE, fig.cap = "CF = Collector Filterer, CG = Collector Gatherer, SC = Scrapers (a composite of SCe and SCi), SCe = Scrapers that are edible, SCi = Scrapers that are inedible, P = Predators"}
ggplot(data = ffg.SC, aes(x = FFG, y = Diff, color = CollDate, shape = Stream)) + 
  geom_jitter(width = .2, height = .2, size = 4) +
  ggtitle("FFG Differences Between Reaches Pre and Post Gap Years") +
  theme_bw() +
  theme(plot.title = element_text(size = 20, face = "bold")) +
  scale_color_viridis_d(option = "E") +
  coord_flip()

```

Here we plot density differences of FFG's.  

 
Notice the only group with consistently elevated differences in the post gap year (2018) is Scrapers.


```{r Plot 2018 FFG Densities, fig.height = 10, fig.width = 12, echo = FALSE}
bugs18 %>%
  group_by(Stream, Treatment, FFG) %>%
  summarise_at(vars(Density), funs(sum)) %>% 
  ungroup() %>%
  ggplot(aes(x = FFG, y = Density, color = Treatment, shape = Stream)) + 
    geom_jitter(width = .2, height = .2, size = 4) + 
    ggtitle("2018 FFG Densities (Control & Treatment)")  +
    theme_bw() +
    theme(plot.title = element_text(size = 20, face = "bold")) +
    scale_color_viridis_d(option = "E") +
    coord_flip()
```

Here we can see that Collector Gatherers are the most abundant taxa, but the aggregate of the two scraper categories (SCe and SCi) is also up there. 

When comparing between the reaches we see elevated abundances of both scraper groups (except for SCi in CHUCK).  Collector Gatherers are also consistently elevated (except in CHUCK), which seems contradictory to the between year comparison (Control reach has always had elevated abundances of CG's?)

- Will these functional feeding groups be important in diets? 

- Does the relative change in abundance of a taxa group change fish selection  (i.e. now that there are more scrapers in the treatment reach are the fish going to town on Scrapers?)

- TBD. (see other.md file in the Diets project)


```{r Scraper Taxa Density Differences, fig.height=10, fig.width=12, echo=FALSE}
bugs.by.year %>% filter(FFG == "SCe" | FFG == "SCi") %>% 
  ggplot(aes(x = Taxon, y = Diff, color = CollDate, shape = Stream)) + 
    geom_jitter(width = .2, height = .2, size = 4) +
    ggtitle("Diff. Between Reaches of Scraper Taxa (2017 & 2018") +
    theme_bw() +
    theme(plot.title = element_text(size = 20, face = "bold")) +
    scale_color_viridis_d(option = "E") +
    coord_flip()
```

Here we see that the Scraper taxa with the greatest change are: 

- Micrasema

- Juga

- Glossosoma

- Drunella

- Heptageniidae taxa


```{r Plot 2018 Scraper Taxa, fig.height = 10, fig.width = 12, echo = FALSE}
bugs18 %>% filter(FFG == "SCe" | FFG == "SCi") %>%
  ggplot(aes(x = Taxon, y = Density, color = Treatment, shape = Stream)) +
    geom_jitter(width = .2, height = .2, size = 4) +
    ggtitle("Density of Scraper Taxa in 2018") +
    theme_bw() +
    theme(plot.title = element_text(size = 20, face = "bold")) +
    scale_color_viridis_d(option = "E") +
    coord_flip()
```


```{r Plot Size Differences, fig.height = 10, fig.width = 12, echo = FALSE}
bugs.by.year %>% 
  group_by(Size, Stream, CollDate) %>%
  summarise_at(vars(Diff), funs(sum)) %>%
  ungroup() %>%
    ggplot(aes(x = Size, y = Diff, color = CollDate, shape = Stream)) + 
      geom_jitter( width = .2, height = .2, size = 4) +
      ggtitle("Differences in Size Classes") +
      theme_bw() +
      theme(plot.title = element_text(size = 20, face = "bold")) +
      scale_color_viridis_d(option = "E")
```

Two size classes are plotted, small (S) and large (L) based on nothing, just observation... Hopefully I will soon incorporate some information from the Poff database about final larval instar size and have three size classes: small, medium, and large.


### NMDS 	:metal:
***
Who knows what I'm actually doing, all of this ordination stuff is currently pre BOT 570.  I will definitely update all this once I know how to handle singleton taxa, loads of zero's, etc.

```{r Prep NMDS Data, echo = FALSE}
# Spread data to get a taxon matrix, create factor of CollDate and Treatment
bugs.mds <- bugs.agg %>% 
  select(-c("FFG", "Size")) %>%
  group_by(Stream, Treatment, CollDate, Taxon) %>%  
  spread(key = "Taxon", value = "Density") %>%
  mutate_if(is.numeric , replace_na, replace = 0) %>% ungroup() %>%
  mutate(YearTreat = interaction(CollDate, Treatment))
```


```{r Make Grouping and Taxon Matrix, echo = FALSE}
# Get grouping variables and taxon matrix
Enviro <- bugs.mds %>%
  select(Stream, Treatment, CollDate, YearTreat) 

Density <- bugs.mds %>% 
  select("Ameletus":"Zapada")

grouping <- select(Enviro, Stream, Treatment, CollDate, YearTreat)
```


```{r NMDS sol, echo = FALSE}
#Get MDS for invert density
sol <- metaMDS(Density, distance = "bray", k = 2, trymax = 100)
```

This is a pretty good stress value, who knows how that will change when I start doing this right...
Can see the transfrmations applied at the top of the output, this was done automatically, I wouldn't know what to do. Used the Bray-Curtis distance metric, max tries is set to 100 with dimensions equal to 2.

```{r NMDS, echo = FALSE}
#set up NMDS with dimensions of sol and env factors from "Enviro". 
NMDS <- data.frame(x = sol$points[, 1], y = sol$points[ ,2], 
                   Stream = select(grouping, Stream), 
                   Treatment = select(grouping, Treatment), 
                   CollDate = select(grouping, CollDate),
                   YearTreat = select(grouping, YearTreat))
```


```{r Mean NMDS, echo = FALSE}
#Get mean x,y values 
NMDS.mean <- select(NMDS, x, y) %>% aggregate(grouping, mean)
```


```{r ELlipse, include = FALSE}
#Load ellipse for NMDS
plot.new()
ord <- ordiellipse(sol, NMDS$YearTreat, display = "sites", kind = "sd", conf = 0.95, label = TRUE)
dev.off()
```

The "display" argument can be set to "site" or "species" depending on what you want to group. "kind" can be standard deviation or standard error, not sure which to use here.

```{r Fit Ellipse, echo=TRUE}
# Fit the ellipse function to actual data
df_ell <- data.frame()
for(g in NMDS$YearTreat){
  df_ell <- rbind(df_ell, cbind(as.data.frame(with(NMDS[NMDS$YearTreat == g,],
                  vegan:::veganCovEllipse(ord[[g]]$cov, ord[[g]]$center, ord[[g]]$scale)))
                                ,YearTreat = g))
}
```

not going to pretend like I know how this works, got it from https://stackoverflow.com/questions/13794419/plotting-ordiellipse-function-from-vegan-package-onto-nmds-plot-created-in-ggplo 
but I do know that changing the column selected from NMDS changes which variable is used for grouping.

```{r Plot Benthic NMDS, fig.height = 10, fig.width = 12, echo = FALSE}
ggplot(data = NMDS, aes(x, y, color = YearTreat)) +
  geom_path(data = df_ell, aes(x = NMDS1, y = NMDS2)) +
  annotate("text", x = (NMDS$x), y = (NMDS$y) + .04, label = NMDS$Stream, size = 2) +
  geom_point(aes(shape = Stream)) +
  ggtitle("NMDS of Benthic Invertebrate Community") +
  theme_bw() +
  theme(plot.title = element_text(size = 20, face = "bold")) +
  scale_color_viridis_d()
```

Actually maybe cool result, all of the treatment reaches now plot closer post-gap year. The controls show a similar pattern though maybe a little less pronounced. Everything also shifted left between the two years, although this isn't because of the treatment, just annual changes. Maybe the gap amplified whatever effect the year had, extra, extra light or temperature maybe.


```{r}
sessionInfo()
```

