---
title: "Diets"
author: "Cedar Mackaness"
date: "11/21/2018"
output: github_document 
---
The goals here are to:

- Calculate the percent of each taxa in each fish's diet 

- Calculate the percent of fish with each specific taxa in its diet

- Do some NMDS up in heya


```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Load Packages, include  =FALSE}
# Load Required Packages
packages <- c("tidyverse", "vegan", "lubridate", "readxl")
lapply(packages, library, character.only = TRUE)
```

```{r Import data, include = FALSE}
# import data
bugs <- readxl::read_xlsx("./Data/2017-18 bugs.xlsx", sheet = "Cleaned")
ffg <- readxl::read_xlsx("./Data/2017-18 bugs.xlsx", sheet = "FFG")
sizes <- readxl::read_xlsx("./Data/2017-18 bugs.xlsx", sheet = "Size")
Diets <- readxl::read_xlsx("./Data/2018 Diets.xlsx")

#Replace Ssp. in Taxon with Family
bugs$Taxon[bugs$Taxon == "Ssp."] <- bugs$Family[bugs$Taxon == "Ssp."]
```


```{r Calculate Densities, ech = TRUE}
#Calculations...
bugs$Density <- bugs$Count / bugs$PercentSub / .09

bugs$CollDate <- as.Date(bugs$CollDate, format = "%m/%d/%y") %>% year() %>% as.factor()

bugs.agg <- aggregate(Density ~ CollDate + Stream + Treatment + Taxon, sum, data = bugs) 

bugs.agg$Density <- bugs.agg$Density / 3
```

Here we divide Count by percent subsampled (actually a fraction) to get a count for the total sample taken.  We then divide by .09 which is the area of the surber sampler (in m$^2$). After these adjustments have been made and the data aggregated (remember the data is structured so that each individual bug gets its own row, i.e. multiple occurances of "*Baetis*") we divide by three because at this point the three samples per reach in 2017 have been aggregated together and 2018 samples have been adjusted to the same value when dividing by percent sub.  (There were three samples taken per reach).

```{r Fill Missing Taxa, echo = FALSE}
# Spread and then gather to fill missing Taxons with 0's
bugs.agg <- spread(bugs.agg, key = "Taxon", value = "Density") %>% 
  mutate_if(is.numeric , replace_na, replace = 0) %>% 
  gather(key = "Taxon", value = "Density", "Ameletus":"Zapada")
```

```{r Calculate Reach Differences, echo = FALSE}
# Create list of CollDate, Stream and Taxon
bugs.by.year <- bugs.agg %>% select(-c("Density", "Treatment")) %>% unique()

# Calculate Differences
bugs.by.year$Diff <- bugs.agg$Density[bugs.agg$Treatment == "Y"] -     
  bugs.agg$Density[bugs.agg$Treatment == "N"]
```

```{r Add FFG and Sizes, echo = FALSE}
# Add FFG and Size Classes
bugs.by.year <- merge(bugs.by.year, sizes) %>% merge(., ffg)
bugs.agg <- merge(bugs.agg, sizes) %>% merge(., ffg)

# Filter for only 2018 benthic taxa to use with Diets
bugs18 <- filter(bugs.agg, CollDate == "2018")
```


```{r Clean Up Diet Data, echo = FALSE}
# Fill missing family's with order
Diets$Family[is.na(Diets$Family)] <- Diets$Order[is.na(Diets$Family)]

# Merge diets, sizes and FFG's
Diets <- merge(Diets, sizes, by.x = "Family", by.y = "Taxon", all.x = TRUE) %>% 
  merge(., ffg, by.x = "Family", by.y = "Taxon", all.x = TRUE)

# Aggregate by rep
Diets.by.fish <- Diets %>% 
  group_by(Family, Stream, Treatment, Origin, FFG, Size, Rep) %>%
  summarise_at("Count", funs(sum)) %>% ungroup

# Aggregate by reach
Diets.reach <- Diets %>% 
  group_by(Family, Stream, Treatment, Origin, FFG, Size) %>%
  summarise_at("Count", funs(sum)) %>% ungroup
```

```{r Merge Diet and Benthic Data, echo = FALSE}
bugs.family <- bugs %>% 
  filter(CollDate == "2018") %>%
  select(-Taxon) %>% 
  group_by(Stream, Treatment, Family, CollDate) %>%
  summarise_at(vars(Density), funs(sum))

bugndiet <- merge(Diets.reach, bugs.family, all.x = TRUE, all.y = TRUE) %>% 
  filter(Origin == "A") %>%
  mutate_if(is.numeric, replace_na, replace = 0)
```


```{r Calculate Taxa Proportions, include = FALSE}
# Calculate proportions of each taxa in the diet and benthic communites
familyndiet <- bugndiet %>% 
  group_by(Stream, Treatment, Family) %>% 
  summarise_if(is.numeric, funs(sum)) %>% 
  mutate(frac.diet = Count / sum(Count)) %>%
  mutate(frac.benthic = Density / sum(Density))
```

```{r Calculate FFG Proportions, include = FALSE}
# Calculate proportions of each FFG in diet and Benthic communities
ffgndiet <- bugndiet %>% 
  group_by(Stream, Treatment, FFG) %>% 
  summarise_if(is.numeric, funs(sum)) %>% 
  mutate(frac.diet = Count / sum(Count)) %>%
  mutate(frac.benthic = Density / sum(Density)) %>%
  mutate_if(is.character, replace_na, replace = "T")
```

```{r Calculate Size Proportions, include = FALSE}
# Calculate proportions of each size class in diet and Benthic communities
sizendiet <- bugndiet %>% 
  group_by(Stream, Treatment, Size) %>% 
  summarise_if(is.numeric, funs(sum)) %>% 
  mutate(frac.diet = Count / sum(Count)) %>%
  mutate(frac.benthic = Density / sum(Density)) %>%
  mutate_if(is.character, replace_na, replace = "T")
```

## Plots of Benthic Vs. Diet Community Composition
### By Family

```{r Plot Taxa Proportions, echo = FALSE, fig.height = 12, fig.width = 12}
# Plot proportion of a taxon in the benthic community versus proporion of a taxon in the diet community
ggplot(data = familyndiet, aes(x = frac.benthic, y = frac.diet, color = Treatment)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  coord_cartesian(ylim = c(0, .8), xlim = c(0, .8)) +
  geom_text(aes(x = frac.benthic, y = frac.diet, label = Family), size = 3, nudge_y = .02) +
  facet_wrap("Stream") +
  ggtitle("1-1 Prop. of Taxa in Benthic Comm. Vs. Prop. in Diets") +
  theme_bw() +
  theme(plot.title = element_text(size = 20, face = "bold")) +
  scale_color_viridis_d(option = "E")
```

Plot of proportional abundance of an individual taxon in the benthic community versus the proportional abundance of the aggregate diets for that reach. 

Here we see that Chironomidae typically make up the greatest abundance of both the fish diets and the benthic community, with LOON being the exception (Brachycentridae are equally represented in the diets of control reach and over represented in the treatment). In MCTE, Juga compose a large part of the diets relative to their abundance due to one outlier fish. 

There are no overarching differences in how a taxa maps out given the treatment, but the difference in Brachycentridae in LOON between treatment and control is interesting.

### By FFG

```{r Plot FFG Proportions, echo = FALSE, fig.height = 12, fig.width = 12}
# Plot proportion of a FFG in the benthic community versus proporion of a FFG in the diet community
ggplot(data = ffgndiet, aes(x = frac.benthic, y = frac.diet, color = Treatment)) +
  geom_point() +
  geom_abline(slope = 1, intercept = 0) +
  coord_cartesian(ylim = c(0, 1), xlim = c(0, 1)) +
  geom_text(aes(x = frac.benthic, y = frac.diet, label = FFG), size = 4, nudge_y = .02) +
  facet_wrap("Stream") +
  ggtitle("1-1 Prop. of FFG's in Benthic Comm. Vs. Prop. in Diets") +
  theme_bw() +
  theme(plot.title = element_text(size = 20, face = "bold")) +
  scale_color_viridis_d(option = "E")
```

Plot of proportional abundance of an individual FFG in the benthic community versus the proportional abundance of the aggregate diets for that reach.

We see that Collector Gatherers and Shredders are the most abundant both in diets and in the benthic community.  There aren't any over arching trends in how FFG's fall out by treatment.


### By Size Class

```{r Plot Size Proportions, echo = FALSE, fig.height = 12, fig.width = 12}
# Plot proportion of a size class in the benthic community versus proporion of a FFG in the diet community
ggplot(data = sizendiet, aes(x = frac.benthic, y = frac.diet, color = Treatment)) +
  geom_point() +
  geom_text(aes(x = frac.benthic, y = frac.diet, label = Size), size = 4, nudge_y = .02) +
  geom_abline(slope = 1, intercept = 0) +
  coord_cartesian(ylim = c(0, 1), xlim = c(0, 1)) +
  facet_wrap("Stream") +
  ggtitle("1-1 Prop. of Size Classes in Benthic Comm. Vs. Prop. in Diets") +
  theme_bw() +
  theme(plot.title = element_text(size = 20, face = "bold")) +
  scale_color_viridis_d(option = "E")
```

Plot of proportional abundance of an individual size class in the benthic community versus the proportional abundance of the aggregate diets for that reach.


### Costello method plot

```{r Costello Data, echo = FALSE}
Diets.fish <- Diets.by.fish %>% 
  group_by(Stream, Treatment, Rep) %>%
  mutate(frac.diet = Count / sum(Count))

Diets.fish <- Diets.fish %>% 
  group_by(Stream, Treatment, Family) %>%
  mutate(frac.fish = length(Family[Count > 0])) %>%
  group_by(Stream, Treatment) %>%
  mutate(frac.fish = frac.fish / max(Rep)) %>%
  group_by(Stream, Treatment, Family)

Diets.fish <- Diets.fish %>%
  summarise_at(vars(frac.fish, frac.diet), funs(mean))
```


```{r Plot Costello, echo = FALSE, fig.height = 12, fig.width = 12}

ggplot(data = Diets.fish) +
  geom_point(mapping = aes(x = frac.fish, y = frac.diet, color = Treatment)) +
  geom_text(aes(x = frac.fish, y = frac.diet, label = Family), size = 3, nudge_y = .02) +
  geom_abline(slope = 1, intercept = 0) +
  coord_cartesian(ylim = c(0, 1), xlim = c(0, 1)) +
  facet_wrap("Stream") +
  ggtitle("Costello Plot of Prop. Fish Occurance Vs. Prop. Diet Community") +
  theme_bw() +
  theme(plot.title = element_text(size = 20, face = "bold")) +
  scale_color_viridis_d(option = "E")
```

The Costello method plots % occurance of a taxon in fish versus % of aggregate diet. With the adjusted method the aggregate diet is only of fish that had the taxon present (ignoring zero values).  We see that in MCTE and in W-100 there seem to be just a couple fish that specifically target Juga and ELmidae respectively. In MCTE, the taxa from treatment diets seem to consistently constitute a smaller portion of the diet than would be expected given how many fish they occur in. 



## NMDS :metal:

Who knows what I'm actually doing, all of this ordination stuff is currently pre BOT 570.  I will definitely update all this once I know how to handle singleton taxa, loads of zero's, etc.

```{r Prep NMDS Data, echo = FALSE}
# Spread data to get a taxon matrix, create factor of CollDate and Treatment
bugs.mds <- Diets.reach %>% 
  filter(Origin %in% c("A", "T")) %>%
  select(-c("FFG", "Size", "Origin")) %>%
  slice(-65) %>%
  spread(key = "Family", value = "Count") %>%
  mutate_if(is.numeric , replace_na, replace = 0) 
```


```{r Make Grouping and Taxon Matrix, echo = FALSE}
# Get grouping variables and taxon matrix
Enviro <- bugs.mds %>%
  select(Stream, Treatment) 

Density <- bugs.mds %>% 
  select("Amphizoidae":"Uenoidae")

grouping <- select(Enviro, Stream, Treatment)
```


```{r NMDS sol, echo = FALSE}
#Get MDS for invert density
sol <- metaMDS(Density, distance = "bray", k = 2, trymax = 100)
```


```{r NMDS, echo = FALSE}
#set up NMDS with dimensions of sol and env factors from "Enviro". 
NMDS <- data.frame(x = sol$points[, 1], y = sol$points[ ,2], 
                   Stream = select(grouping, Stream), 
                   Treatment = select(grouping, Treatment))
```


```{r Mean NMDS, echo = FALSE}
#Get mean x,y values 
NMDS.mean <- select(NMDS, x, y) %>% aggregate(grouping, mean)
```


```{r ELlipse, include = FALSE}
#Load ellipse for NMDS
plot.new()
ord <- ordiellipse(sol, NMDS$Treatment, display = "sites", kind = "sd", conf = 0.95, label = TRUE)
dev.off()
```

The "display" argument can be set to "site" or "species" depending on what you want to group. "kind" can be standard deviation or standard error, not sure which to use here.

```{r Fit Ellipse, echo = TRUE}
# Fit the ellipse function to actual data
df_ell <- data.frame()
for(g in NMDS$Treatment){
  df_ell <- rbind(df_ell, cbind(as.data.frame(with(NMDS[NMDS$Treatment == g,],
                  vegan:::veganCovEllipse(ord[[g]]$cov, ord[[g]]$center, ord[[g]]$scale)))
                                ,Treatment = g))
}
```

not going to pretend like I know how this works, got it from https://stackoverflow.com/questions/13794419/plotting-ordiellipse-function-from-vegan-package-onto-nmds-plot-created-in-ggplo 
but I do know that changing the column selected from NMDS changes which variable is used for grouping.

```{r NMDS Plot6, fig.height = 10, fig.width = 12, echo = FALSE}
ggplot(data = NMDS, aes(x, y, color = Treatment)) +
  geom_path(data = df_ell, aes(x = NMDS1, y = NMDS2)) +
  annotate("text", x = (NMDS$x), y = (NMDS$y) + .04, label = NMDS$Stream, size = 3) +
  geom_point(aes(shape = Stream)) +
  ggtitle("NMDS of Community in Fish Diets") +
  theme_bw() +
  theme(plot.title = element_text(size = 20, face = "bold")) +
  scale_color_viridis_d()
```

There seems to be total overlap of the diet communities in the control versus treatment reaches.  This seems to be consistent with what we saw in other plots.
